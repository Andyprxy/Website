<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farm Mania | Master Command Center v1.2</title>
    
    <!-- TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- CHART.JS (Stable 3.9.1) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

    <!-- PAPAPARSE (For Robust CSV Reading) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <!-- SHEETJS (For Excel Files) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root { --primary: #065f46; --bg-color: #f5f5f4; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: #1f2937; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #e7e5e4; }
        ::-webkit-scrollbar-thumb { background: #a8a29e; border-radius: 3px; }
        
        .nav-item.active { background-color: #ecfccb; color: #365314; border-right: 4px solid #365314; }
        .chart-container { position: relative; height: 280px; width: 100%; }
        
        .console-output { background: #1f2937; color: #10b981; font-family: 'Courier New', monospace; padding: 12px; border-radius: 6px; height: 180px; overflow-y: auto; font-size: 0.75rem; border-left: 4px solid var(--primary); }
        .log-entry { margin-bottom: 6px; border-bottom: 1px solid #374151; padding-bottom: 4px; }
        .shake { animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both; transform: translate3d(0, 0, 0); backface-visibility: hidden; perspective: 1000px; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <!-- SIDEBAR -->
    <aside class="w-64 bg-white border-r border-stone-200 flex flex-col hidden md:flex shadow-sm z-20 relative">
        <div class="p-6 border-b border-stone-100">
            <h1 class="text-2xl font-bold text-emerald-800 tracking-tight flex items-center gap-2"><span>üêî</span> Farm Mania</h1>
            <p class="text-xs text-stone-500 mt-1">Master Command Center</p>
        </div>
        <nav class="flex-1 overflow-y-auto py-4">
            <div class="px-6 mb-2"><p class="text-xs font-bold text-stone-400 uppercase tracking-wider">Analytics</p></div>
            <ul class="space-y-1 mb-6">
                <li><button onclick="app.navigate('dashboard')" id="nav-dashboard" class="nav-item active w-full text-left px-6 py-3 hover:bg-stone-50 transition-colors flex items-center gap-3 text-sm font-medium"><span>üìä</span> Dashboard Overview</button></li>
                <li><button onclick="app.navigate('sales')" id="nav-sales" class="nav-item w-full text-left px-6 py-3 hover:bg-stone-50 transition-colors flex items-center gap-3 text-sm font-medium"><span>üí∞</span> Sales Performance</button></li>
            </ul>
            <div class="px-6 mb-2"><p class="text-xs font-bold text-stone-400 uppercase tracking-wider">Operations</p></div>
            <ul class="space-y-1">
                <li><button onclick="app.navigate('inventory')" id="nav-inventory" class="nav-item w-full text-left px-6 py-3 hover:bg-stone-50 transition-colors flex items-center gap-3 text-sm font-medium"><span>üè∑Ô∏è</span> Price & Stock Manager</button></li>
                <li><button onclick="app.navigate('customers')" id="nav-customers" class="nav-item w-full text-left px-6 py-3 hover:bg-stone-50 transition-colors flex items-center gap-3 text-sm font-medium"><span>üë•</span> Customer Insights</button></li>
            </ul>
        </nav>
        <div class="p-4 border-t border-stone-100 space-y-3">
            <button onclick="app.openAdminModal()" class="w-full bg-stone-100 hover:bg-stone-200 text-stone-600 font-bold py-2 rounded border border-stone-300 transition-colors flex items-center justify-center gap-2 text-xs"><span>üîí</span> Connect Google Sheet</button>
            <button onclick="app.hardReset()" class="w-full bg-red-50 hover:bg-red-100 text-red-600 font-bold py-2 rounded border border-red-200 transition-colors flex items-center justify-center gap-2 text-xs">‚ö†Ô∏è Reset App Data</button>
            <div id="sync-status" class="text-[10px] text-center text-stone-400 font-mono">Not Connected</div>
        </div>
        <!-- VERSION INDICATOR -->
        <div class="absolute bottom-1 right-2 text-[9px] text-stone-400 font-mono">v1.2</div>
    </aside>

    <!-- MOBILE HEADER -->
    <div class="md:hidden fixed top-0 left-0 w-full bg-white border-b border-stone-200 z-20 px-4 py-3 flex justify-between items-center">
        <h1 class="font-bold text-emerald-800">Farm Mania</h1>
        <button onclick="document.getElementById('mobile-menu').classList.toggle('hidden')" class="text-2xl">‚ò∞</button>
    </div>

    <!-- MAIN CONTENT -->
    <main class="flex-1 h-screen overflow-y-auto bg-stone-50 p-4 md:p-8 pt-16 md:pt-8 relative">
        
        <!-- DASHBOARD VIEW -->
        <div id="view-dashboard" class="space-y-6 animate-fade-in">
            <header class="flex justify-between items-end">
                <div>
                    <h2 class="text-3xl font-bold text-stone-800">Owner's Dashboard</h2>
                    <p class="text-stone-500 mt-2 max-w-3xl text-sm leading-relaxed">
                        Welcome back. Here is a high-level overview of Farm Mania's performance based on recent WhatsApp order logs and inventory counts. Use this snapshot to track revenue velocity and stock health.
                    </p>
                </div>
                <button onclick="app.refreshData()" class="bg-white border border-stone-200 hover:bg-stone-50 text-stone-600 px-3 py-1.5 rounded text-sm flex items-center gap-2 shadow-sm">üîÑ Refresh Data</button>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-l-emerald-500 border border-stone-100">
                    <p class="text-xs font-bold text-stone-400 uppercase tracking-wider">Total Revenue</p>
                    <h3 class="text-2xl font-bold text-stone-800 mt-1" id="kpi-revenue">R0.00</h3>
                </div>
                <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-l-blue-500 border border-stone-100">
                    <p class="text-xs font-bold text-stone-400 uppercase tracking-wider">Total Orders</p>
                    <h3 class="text-2xl font-bold text-stone-800 mt-1" id="kpi-orders">0</h3>
                </div>
                <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-l-amber-500 border border-stone-100">
                    <p class="text-xs font-bold text-stone-400 uppercase tracking-wider">Best Seller</p>
                    <h3 class="text-lg font-bold text-stone-800 mt-1 truncate" id="kpi-product">-</h3>
                </div>
                <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-l-purple-500 border border-stone-100">
                    <p class="text-xs font-bold text-stone-400 uppercase tracking-wider">Asset Value</p>
                    <h3 class="text-2xl font-bold text-stone-800 mt-1" id="kpi-stock">R0.00</h3>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-stone-100">
                    <h3 class="font-bold text-lg text-stone-700 mb-4">Daily Revenue Trend</h3>
                    <div class="chart-container"><canvas id="revenueChart"></canvas></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-100">
                    <h3 class="font-bold text-lg text-stone-700 mb-4">Payment Methods</h3>
                    <div class="chart-container" style="height: 250px;"><canvas id="paymentChart"></canvas></div>
                    <div class="mt-4 text-center text-xs text-stone-400">Top Method: <strong class="text-stone-700" id="top-payment-method">-</strong></div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-stone-100 overflow-hidden">
                <div class="px-6 py-4 border-b border-stone-100 flex justify-between items-center"><h3 class="font-bold text-stone-700">Recent Activity (Newest First)</h3></div>
                <div class="overflow-x-auto"><table class="w-full text-sm text-left"><tbody id="table-recent"></tbody></table></div>
            </div>
        </div>

        <!-- SALES VIEW -->
        <div id="view-sales" class="hidden space-y-6 animate-fade-in">
            <header><h2 class="text-3xl font-bold text-stone-800">Sales Performance</h2></header>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-100"><h3 class="font-bold text-lg text-stone-700 mb-4">Sales by Product</h3><div class="chart-container"><canvas id="productSalesChart"></canvas></div></div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-100"><h3 class="font-bold text-lg text-stone-700 mb-4">Peak Ordering Times</h3><div class="chart-container"><canvas id="timeOfDayChart"></canvas></div></div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-stone-100 overflow-hidden">
                <div class="px-6 py-4 border-b border-stone-100 bg-stone-50"><h3 class="font-bold text-stone-700">Complete Sales Log</h3></div>
                <div class="overflow-x-auto" style="max-height: 500px;">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-white text-stone-500 uppercase text-xs border-b border-stone-100 sticky top-0"><tr><th class="px-6 py-3">Date</th><th class="px-6 py-3">Customer</th><th class="px-6 py-3">Product</th><th class="px-6 py-3 text-center">Qty</th><th class="px-6 py-3 text-right">Total</th></tr></thead>
                        <tbody id="table-sales" class="divide-y divide-stone-100"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- OPERATIONS VIEW -->
        <div id="view-inventory" class="hidden space-y-6 animate-fade-in">
            <header><h2 class="text-3xl font-bold text-stone-800">Price & Stock Manager</h2><p class="text-stone-500 mt-1">Update inventory levels and adjust product selling prices.</p></header>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 space-y-6">
                    <div class="bg-white rounded-xl shadow-sm border border-stone-100 overflow-hidden">
                        <div class="px-6 py-4 border-b border-stone-100 bg-stone-50 flex justify-between items-center"><h3 class="font-bold text-stone-700">Current Stock</h3><span class="text-xs bg-emerald-100 text-emerald-800 px-2 py-1 rounded">Live Pricing</span></div>
                        <div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="bg-white text-stone-500 uppercase text-xs border-b border-stone-100"><tr><th class="px-6 py-3">Item</th><th class="px-6 py-3 text-right">Stock</th><th class="px-6 py-3 text-right">Selling Price</th><th class="px-6 py-3 text-right">Potential Value</th></tr></thead><tbody id="table-inventory" class="divide-y divide-stone-100"></tbody></table></div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-stone-100 p-4"><h3 class="font-bold text-stone-700 mb-2 text-xs uppercase">System Audit Log</h3><div id="console-output" class="console-output"></div></div>
                </div>
                <div>
                    <div class="bg-emerald-50 rounded-xl shadow-sm border border-emerald-100 p-6 sticky top-6">
                        <h3 class="font-bold text-emerald-800 mb-4 border-b border-emerald-200 pb-2">üì¶ Manage Product</h3>
                        <div class="space-y-4">
                            <div><label class="block text-xs font-bold text-emerald-700 uppercase mb-1">Select Product</label><select id="restock-id" class="w-full border border-emerald-200 rounded p-2 text-sm bg-white" onchange="app.updatePriceInput()"></select></div>
                            <div class="grid grid-cols-2 gap-3">
                                <div><label class="block text-xs font-bold text-emerald-700 uppercase mb-1">Add Stock (+/-)</label><input type="number" id="restock-qty" value="0" class="w-full border border-emerald-200 rounded p-2 text-sm bg-white"></div>
                                <div><label class="block text-xs font-bold text-emerald-700 uppercase mb-1">New Selling Price</label><input type="number" id="restock-cost" step="0.01" class="w-full border border-emerald-200 rounded p-2 text-sm bg-white font-bold text-emerald-900"></div>
                            </div>
                            <button onclick="app.handleRestock()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 rounded shadow-sm transition-colors text-sm">Update Product</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CUSTOMERS VIEW -->
        <div id="view-customers" class="hidden space-y-6 animate-fade-in">
            <header><h2 class="text-3xl font-bold text-stone-800">Customer Insights</h2><p class="text-stone-500 mt-1">Identify top buyers and delivery hotspots.</p></header>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-100"><h3 class="font-bold text-lg text-stone-700 mb-4">Top 5 Customers (by Volume)</h3><div class="chart-container"><canvas id="customerChart"></canvas></div></div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-100 flex flex-col"><h3 class="font-bold text-lg text-stone-700 mb-4">Customer Directory</h3><div class="flex-1 overflow-auto custom-scrollbar" style="max-height: 300px;"><ul id="customer-list" class="space-y-3"></ul></div></div>
            </div>
        </div>
    </main>

    <!-- ADMIN PASSWORD MODAL -->
    <div id="password-modal" class="fixed inset-0 bg-stone-900/80 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden text-center p-8">
            <div class="mb-4 flex justify-center"><div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center text-2xl">üîí</div></div>
            <h3 class="text-xl font-bold text-stone-800">Admin Access Only</h3>
            <div class="text-sm text-stone-500 mt-2 mb-6 space-y-2">
                <p>This section controls critical system operations.</p>
                <p class="text-red-500 font-bold bg-red-50 py-1 rounded">Unauthorized changes may disrupt services.</p>
                <p>Access code required.</p>
            </div>
            <input type="password" id="admin-pass" class="w-full border border-stone-300 rounded p-3 text-center text-lg tracking-widest mb-4 focus:ring-2 focus:ring-emerald-500 focus:outline-none" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            <div class="flex gap-2">
                <button onclick="document.getElementById('password-modal').classList.add('hidden')" class="flex-1 bg-stone-100 hover:bg-stone-200 text-stone-600 font-bold py-2 rounded text-sm">Cancel</button>
                <button onclick="app.verifyPassword()" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 rounded text-sm">Verify</button>
            </div>
            <p id="pass-error" class="text-red-500 text-xs mt-3 hidden">Incorrect Access Code</p>
        </div>
    </div>

    <!-- SHEET CONNECT MODAL -->
    <div id="sheet-modal" class="fixed inset-0 bg-stone-900/60 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md overflow-hidden">
            <div class="px-6 py-4 border-b border-stone-100 flex justify-between items-center bg-stone-50"><h3 class="font-bold text-stone-800">Connect Google Sheet</h3><button onclick="document.getElementById('sheet-modal').classList.add('hidden')" class="text-stone-400 hover:text-stone-600">‚úï</button></div>
            <div class="p-6 space-y-4">
                <p class="text-sm text-stone-600">Paste your published Google Sheet CSV link below.</p>
                <input id="sheet-url" class="w-full border border-stone-300 rounded p-2 text-sm" placeholder="https://docs.google.com.../pub?output=csv">
                <div class="flex gap-2 pt-2">
                    <button onclick="app.connectSheet()" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 rounded shadow-sm text-sm">Sync Now</button>
                    <button onclick="app.loadDemoData()" class="px-4 py-2 bg-stone-100 hover:bg-stone-200 text-stone-600 rounded text-sm font-bold">Use Demo</button>
                </div>
            </div>
        </div>
    </div>

    <!-- LOGIC -->
    <script>
        // --- CUSTOM DATE DECODER ---
        const parseMyDate = (str) => {
            if (!str) return new Date();
            const s = str.toString().trim().replace(/['"]+/g, '');
            
            // Format: "10-14 Oct 2025" or "10-2 Oct 2025"
            // Split by space first: ["10-14", "Oct", "2025"]
            const parts = s.split(/\s+/);
            
            if (parts.length >= 3) {
                const datePart = parts[0]; // "10-14"
                const monthName = parts[1]; // "Oct"
                const year = parseInt(parts[2]); // "2025"
                
                if (datePart.includes('-')) {
                    // Split "10-14" -> ["10", "14"]
                    const subParts = datePart.split('-');
                    // Assumption: The second number is the DAY (14)
                    const day = parseInt(subParts[1]); 
                    
                    const months = { 'jan':0,'feb':1,'mar':2,'apr':3,'may':4,'jun':5,'jul':6,'aug':7,'sep':8,'oct':9,'nov':10,'dec':11 };
                    const month = months[monthName.toLowerCase().substr(0,3)] || 0;
                    
                    if (!isNaN(day) && !isNaN(year)) {
                        return new Date(year, month, day);
                    }
                }
            }
            return new Date(s); // Fallback
        };

        const state = {
            orders: [],
            inventory: [
                { id: "INV001", name: "Combo Pack", stock: 85, cost: 525.00 },
                { id: "INV002", name: "Whole Chicken (1.3kg)", stock: 50, cost: 65.00 },
                { id: "INV003", name: "Whole Chicken (1.4kg)", stock: 50, cost: 70.00 },
                { id: "INV004", name: "Whole Chicken (1.5kg)", stock: 50, cost: 75.00 },
                { id: "INV005", name: "Whole Chicken (1.6kg)", stock: 50, cost: 80.00 },
                { id: "INV006", name: "Whole Chicken (1.7kg)", stock: 50, cost: 85.00 },
                { id: "INV007", name: "Whole Chicken (1.8kg)", stock: 50, cost: 90.00 },
                { id: "INV008", name: "Whole Chicken (1.9kg)", stock: 50, cost: 95.00 },
                { id: "INV009", name: "Whole Chicken (2.0kg)", stock: 50, cost: 100.00 },
                { id: "INV010", name: "Whole Chicken (2.1kg)", stock: 50, cost: 105.00 },
                { id: "INV011", name: "Whole Chicken (2.2kg)", stock: 50, cost: 110.00 },
                { id: "INV012", name: "Live Chicken", stock: 50, cost: 30.00 },
                { id: "INV013", name: "Chicken Hearts (kg)", stock: 50, cost: 10.00 },
                { id: "INV014", name: "Chicken Necks (kg)", stock: 100, cost: 30.00 },
                { id: "INV015", name: "Chicken Feet (kg)", stock: 100, cost: 25.00 },
                { id: "INV016", name: "Gizzards (kg)", stock: 100, cost: 30.00 },
                { id: "INV017", name: "Livers (kg)", stock: 100, cost: 30.00 },
                { id: "INV018", name: "Mala (kg)", stock: 100, cost: 20.00 },
                { id: "INV019", name: "Large Whole Chicken", stock: 100, cost: 100.00 }
            ],
            sheetUrl: localStorage.getItem('farm_mania_sheet_url') || '',
            charts: {}
        };

        const formatCurrency = (val) => new Intl.NumberFormat('en-ZA', { style: 'currency', currency: 'ZAR' }).format(val);

        const app = {
            init: () => {
                if (window.Chart) {
                    Chart.defaults.font.family = "'Inter', sans-serif";
                    Chart.defaults.color = '#6b7280';
                }
                const savedInv = localStorage.getItem('farm_mania_inventory');
                if (savedInv) state.inventory = JSON.parse(savedInv);

                if (state.sheetUrl) {
                    app.fetchSheetData(state.sheetUrl);
                } else {
                    app.log("No Sheet URL found. Loading robust demo data...");
                    app.loadDemoData(); 
                }
                app.initRestockDropdown();
                app.log("System Initialized (v1.2).");
            },

            hardReset: () => {
                if(confirm("This will disconnect any connected Google Sheet and reset all data to default. Continue?")) {
                    localStorage.removeItem('farm_mania_sheet_url');
                    localStorage.removeItem('farm_mania_inventory');
                    location.reload();
                }
            },

            openAdminModal: () => {
                document.getElementById('admin-pass').value = '';
                document.getElementById('pass-error').classList.add('hidden');
                document.getElementById('password-modal').classList.remove('hidden');
                document.getElementById('admin-pass').focus();
            },

            verifyPassword: () => {
                if (document.getElementById('admin-pass').value === '0000') {
                    document.getElementById('password-modal').classList.add('hidden');
                    document.getElementById('sheet-modal').classList.remove('hidden');
                } else {
                    const modal = document.getElementById('password-modal').firstElementChild;
                    document.getElementById('pass-error').classList.remove('hidden');
                    modal.classList.remove('shake');
                    void modal.offsetWidth; modal.classList.add('shake');
                }
            },

            navigate: (viewId) => {
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active', 'bg-stone-50', 'text-stone-800'));
                document.getElementById('nav-'+viewId).classList.add('active');
                ['dashboard','sales','inventory','customers'].forEach(v => document.getElementById('view-'+v).classList.add('hidden'));
                document.getElementById('view-'+viewId).classList.remove('hidden');
                if (viewId === 'dashboard' || viewId === 'sales' || viewId === 'customers') app.updateDashboard();
            },

            connectSheet: () => {
                const url = document.getElementById('sheet-url').value.trim();
                if(!url) return alert("Please enter a valid URL");
                localStorage.setItem('farm_mania_sheet_url', url);
                state.sheetUrl = url;
                app.fetchSheetData(url);
                document.getElementById('sheet-modal').classList.add('hidden');
            },

            fetchSheetData: (url) => {
                document.getElementById('sync-status').innerText = "Syncing...";
                // Use PapaParse to handle dirty CSVs
                Papa.parse(url, {
                    download: true,
                    header: true,
                    skipEmptyLines: 'greedy',
                    complete: (results) => {
                        app.log(`Received ${results.data.length} raw rows.`);
                        
                        const cleaned = results.data.map((row, idx) => {
                            // Helper to find key efficiently (fuzzy match for "total ", "Total\t", etc)
                            const findKey = (search) => Object.keys(row).find(k => k.toLowerCase().includes(search.toLowerCase()));
                            
                            const totalKey = findKey('total');
                            if (!totalKey) {
                                // app.log(`Row ${idx}: No total found`);
                                return null;
                            }

                            const rawTotal = row[totalKey];
                            const total = parseFloat(rawTotal ? rawTotal.replace(/[R,\s]/g, '') : 0) || 0;
                            if (total === 0) return null; 

                            const idKey = findKey('order') || findKey('id');
                            const nameKey = findKey('name') || findKey('cust'); 
                            const prodKey = findKey('product') || findKey('item'); 
                            const qtyKey = findKey('quantity') || findKey('qty');
                            const payKey = findKey('pay') || findKey('method');
                            const dateKey = findKey('date');

                            const cleanStr = (val) => val ? val.toString().replace(/[\n\r"]/g, '').trim() : '';

                            return {
                                id: cleanStr(row[idKey]) || 'UNK',
                                name: cleanStr(row[nameKey]) || 'Unknown',
                                product: cleanStr(row[prodKey]) || 'Item',
                                price: 0, 
                                qty: parseInt(row[qtyKey]) || 1,
                                total: total,
                                pay: cleanStr(row[payKey]) || 'Cash',
                                date: cleanStr(row[dateKey]) // e.g. "10-2 Oct 2025"
                            };
                        }).filter(o => o);

                        // --- SORTING: NEWEST FIRST ---
                        cleaned.sort((a, b) => {
                            const dateA = parseMyDate(a.date);
                            const dateB = parseMyDate(b.date);
                            return dateB - dateA; // Descending
                        });

                        if(cleaned.length > 0) {
                            state.orders = cleaned;
                            app.updateDashboard();
                            app.renderSalesTable();
                            document.getElementById('sync-status').innerHTML = "üü¢ <span class='text-emerald-600 font-bold'>Live</span>";
                            app.log(`Success: Loaded ${cleaned.length} valid orders.`);
                        } else {
                            app.log("Connected but 0 valid orders found. Check column names?");
                            document.getElementById('sync-status').innerText = "‚ö†Ô∏è 0 Rows";
                        }
                    },
                    error: (err) => {
                        console.error(err);
                        app.log("CSV Error: " + err.message);
                        document.getElementById('sync-status').innerText = "üî¥ Failed";
                        app.log("Switching to Demo Data...");
                        app.loadDemoData();
                    }
                });
            },

            refreshData: () => {
                if(state.sheetUrl) app.fetchSheetData(state.sheetUrl);
                else app.loadDemoData();
            },

            loadDemoData: () => {
                state.orders = [
                    { id: "DEMO-01", name: "Brian", product: "Large Whole Chicken", qty: 2, total: 200.00, pay: "Cash", date: "10-01 Oct 2025" },
                    { id: "DEMO-02", name: "Andile", product: "Whole Chicken (1.5kg)", qty: 5, total: 375.00, pay: "EFT", date: "10-02 Oct 2025" },
                    { id: "DEMO-03", name: "Sarah M.", product: "Combo Pack", qty: 1, total: 525.00, pay: "Card", date: "10-03 Oct 2025" },
                    { id: "DEMO-04", name: "Mama Zodwa", product: "Live Chicken", qty: 10, total: 300.00, pay: "Cash", date: "10-04 Oct 2025" },
                    { id: "DEMO-05", name: "Chicken King", product: "Whole Chicken (1.3kg)", qty: 20, total: 1300.00, pay: "EFT", date: "10-05 Oct 2025" },
                    { id: "DEMO-06", name: "Thabo", product: "Chicken Feet (kg)", qty: 3, total: 75.00, pay: "Cash", date: "10-06 Oct 2025" },
                    { id: "DEMO-07", name: "Lerato", product: "Gizzards (kg)", qty: 2, total: 60.00, pay: "Card", date: "10-07 Oct 2025" },
                    { id: "DEMO-08", name: "Brian", product: "Whole Chicken (1.8kg)", qty: 1, total: 90.00, pay: "Cash", date: "10-08 Oct 2025" },
                    { id: "DEMO-09", name: "Sipho", product: "Mala (kg)", qty: 5, total: 100.00, pay: "Cash", date: "10-09 Oct 2025" },
                    { id: "DEMO-10", name: "Andile", product: "Combo Pack", qty: 2, total: 1050.00, pay: "EFT", date: "10-10 Oct 2025" },
                    { id: "DEMO-11", name: "Nandi", product: "Chicken Necks (kg)", qty: 4, total: 120.00, pay: "Card", date: "10-11 Oct 2025" },
                    { id: "DEMO-12", name: "Mama Zodwa", product: "Live Chicken", qty: 5, total: 150.00, pay: "Cash", date: "10-12 Oct 2025" },
                    { id: "DEMO-13", name: "Khanyi", product: "Whole Chicken (2.0kg)", qty: 2, total: 200.00, pay: "EFT", date: "10-13 Oct 2025" },
                    { id: "DEMO-14", name: "Brian", product: "Livers (kg)", qty: 1, total: 30.00, pay: "Cash", date: "10-14 Oct 2025" },
                    { id: "DEMO-15", name: "David", product: "Large Whole Chicken", qty: 3, total: 300.00, pay: "Card", date: "10-15 Oct 2025" },
                    { id: "DEMO-16", name: "Sarah M.", product: "Whole Chicken (1.4kg)", qty: 2, total: 140.00, pay: "Card", date: "10-16 Oct 2025" },
                    { id: "DEMO-17", name: "Chicken King", product: "Whole Chicken (1.9kg)", qty: 10, total: 950.00, pay: "EFT", date: "10-17 Oct 2025" },
                    { id: "DEMO-18", name: "Thabo", product: "Chicken Hearts (kg)", qty: 2, total: 20.00, pay: "Cash", date: "10-18 Oct 2025" },
                    { id: "DEMO-19", name: "Lerato", product: "Combo Pack", qty: 1, total: 525.00, pay: "Card", date: "10-19 Oct 2025" },
                    { id: "DEMO-20", name: "Sipho", product: "Whole Chicken (2.2kg)", qty: 1, total: 110.00, pay: "Cash", date: "10-20 Oct 2025" }
                ];
                app.updateDashboard();
                app.renderSalesTable();
                app.renderInventoryTable();
                document.getElementById('sheet-modal').classList.add('hidden');
                document.getElementById('sync-status').innerText = "‚ö†Ô∏è Demo Data";
            },

            initRestockDropdown: () => {
                const select = document.getElementById('restock-id');
                select.innerHTML = '';
                state.inventory.forEach(item => {
                    const opt = document.createElement('option');
                    opt.value = item.id;
                    opt.innerText = item.name;
                    select.appendChild(opt);
                });
                app.updatePriceInput();
            },

            updatePriceInput: () => {
                const id = document.getElementById('restock-id').value;
                const item = state.inventory.find(i => i.id === id);
                if(item) document.getElementById('restock-cost').value = item.cost.toFixed(2);
            },

            handleRestock: () => {
                const id = document.getElementById('restock-id').value;
                const qty = parseFloat(document.getElementById('restock-qty').value);
                const price = parseFloat(document.getElementById('restock-cost').value);
                const item = state.inventory.find(i => i.id === id);
                
                if(!item) return;

                const oldPrice = item.cost;
                const oldStock = item.stock;
                const newStock = Math.max(0, oldStock + qty);
                item.cost = price; 
                item.stock = newStock;

                const logMsg = `Updated ${item.name}. Stock: ${oldStock} -> ${newStock}. Price: ${formatCurrency(oldPrice)} -> ${formatCurrency(price)}`;
                localStorage.setItem('farm_mania_inventory', JSON.stringify(state.inventory));

                app.renderInventoryTable();
                app.updateDashboard(); 
                app.log(logMsg);
                alert("Product Updated Successfully!");
            },

            log: (msg) => {
                const div = document.getElementById('console-output');
                div.innerHTML = `<div class="log-entry"><span style="color:#9ca3af">[${new Date().toLocaleTimeString()}]</span> ${msg}</div>` + div.innerHTML;
            },

            renderInventoryTable: () => {
                const tbody = document.getElementById('table-inventory');
                tbody.innerHTML = state.inventory.map(i => `
                    <tr class="bg-white hover:bg-stone-50 border-b border-stone-50">
                        <td class="px-6 py-3 font-medium text-stone-800">${i.name}</td>
                        <td class="px-6 py-3 text-right font-bold">${i.stock}</td>
                        <td class="px-6 py-3 text-right text-stone-500">${formatCurrency(i.cost)}</td>
                        <td class="px-6 py-3 text-right font-bold text-emerald-700">${formatCurrency(i.stock * i.cost)}</td>
                    </tr>
                `).join('');
            },

            renderSalesTable: () => {
                const tbody = document.getElementById('table-sales');
                tbody.innerHTML = state.orders.map(o => `
                    <tr class="bg-white hover:bg-stone-50 border-b border-stone-50">
                        <td class="px-6 py-3 text-stone-500 text-xs whitespace-nowrap">${o.date}</td>
                        <td class="px-6 py-3 font-medium text-stone-800">${o.name}</td>
                        <td class="px-6 py-3 text-stone-600">${o.product}</td>
                        <td class="px-6 py-3 text-center">${o.qty}</td>
                        <td class="px-6 py-3 text-right font-bold text-stone-800">R${o.total}</td>
                    </tr>
                `).join('');
            },

            updateDashboard: () => {
                const totalRev = state.orders.reduce((a,b) => a + b.total, 0);
                const stockVal = state.inventory.reduce((a,b) => a + (b.stock * b.cost), 0);
                const counts = {}; state.orders.forEach(o => counts[o.product] = (counts[o.product] || 0) + o.qty);
                const topProd = Object.keys(counts).sort((a,b) => counts[b] - counts[a])[0] || '-';
                const payStats = {}; state.orders.forEach(o => payStats[o.pay] = (payStats[o.pay] || 0) + 1);
                const topPay = Object.keys(payStats).sort((a,b) => payStats[b] - payStats[a])[0] || '-';
                const custCounts = {}; state.orders.forEach(o => custCounts[o.name] = (custCounts[o.name] || 0) + o.total);
                const sortedCust = Object.entries(custCounts).sort((a,b) => b[1] - a[1]).slice(0, 5);

                document.getElementById('kpi-revenue').innerText = formatCurrency(totalRev);
                document.getElementById('kpi-orders').innerText = state.orders.length;
                document.getElementById('kpi-product').innerText = topProd;
                document.getElementById('kpi-stock').innerText = formatCurrency(stockVal);
                document.getElementById('top-payment-method').innerText = topPay;

                document.getElementById('customer-list').innerHTML = sortedCust.map(([name, val], i) => `
                    <li class="flex items-center justify-between p-3 bg-stone-50 rounded-lg border border-stone-100 mb-2 shadow-sm">
                        <div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-emerald-100 text-emerald-800 flex items-center justify-center text-xs font-bold border border-emerald-200">${name.charAt(0)}</div><div><p class="text-sm font-bold text-stone-700">${name}</p><p class="text-xs text-stone-400">Rank #${i + 1}</p></div></div>
                        <div class="text-right"><p class="text-sm font-bold text-emerald-700">${formatCurrency(val)}</p></div>
                    </li>
                `).join('');

                document.getElementById('table-recent').innerHTML = state.orders.slice(0,5).map(o => `
                    <tr class="bg-white hover:bg-stone-50 border-b border-stone-50">
                        <td class="px-6 py-3 text-xs text-stone-400 font-mono">${o.id}</td>
                        <td class="px-6 py-3 font-medium text-stone-800">${o.name}</td>
                        <td class="px-6 py-3 text-stone-500 text-xs">${o.product}</td>
                        <td class="px-6 py-3 text-right font-bold text-stone-800">R${o.total}</td>
                    </tr>
                `).join('');

                app.renderCharts(counts, payStats, sortedCust);
            },

            renderCharts: (productData, payData, sortedCust) => {
                if (!window.Chart || !document.getElementById('revenueChart')) return;

                const salesByDate = {};
                // Reverse to show trend left to right (Oldest -> Newest)
                const chronoOrders = [...state.orders].reverse();
                
                chronoOrders.forEach(o => {
                    const dateObj = parseMyDate(o.date);
                    const key = dateObj.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
                    salesByDate[key] = (salesByDate[key] || 0) + o.total;
                });
                const labels = Object.keys(salesByDate).slice(-7);
                const data = labels.map(k => salesByDate[k]);

                ['revenue', 'payment', 'productSales', 'time', 'customer'].forEach(k => {
                    if (state.charts[k]) { state.charts[k].destroy(); state.charts[k] = null; }
                });

                const ctxRev = document.getElementById('revenueChart').getContext('2d');
                state.charts.revenue = new Chart(ctxRev, {
                    type: 'line',
                    data: { labels: labels, datasets: [{ label: 'Revenue', data: data, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', fill: true, tension: 0.3 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { borderDash: [2,2] } }, x: { grid: { display: false } } } }
                });

                const ctxPay = document.getElementById('paymentChart').getContext('2d');
                state.charts.payment = new Chart(ctxPay, { type: 'doughnut', data: { labels: Object.keys(payData), datasets: [{ data: Object.values(payData), backgroundColor: ['#f59e0b', '#3b82f6', '#10b981'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'right' } } } });

                const ctxProd = document.getElementById('productSalesChart').getContext('2d');
                state.charts.productSales = new Chart(ctxProd, { type: 'pie', data: { labels: Object.keys(productData), datasets: [{ data: Object.values(productData), backgroundColor: ['#84cc16', '#14b8a6', '#f43f5e', '#6366f1', '#f59e0b'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } } });

                const ctxTime = document.getElementById('timeOfDayChart').getContext('2d');
                state.charts.time = new Chart(ctxTime, { type: 'bar', data: { labels: ['AM', 'PM'], datasets: [{ label: 'Orders', data: [10, 20], backgroundColor: '#6366f1', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false } }, y: { beginAtZero: true } } } });

                const ctxCust = document.getElementById('customerChart').getContext('2d');
                state.charts.customer = new Chart(ctxCust, { type: 'bar', data: { labels: sortedCust.map(c => c[0]), datasets: [{ label: 'Spend', data: sortedCust.map(c => c[1]), backgroundColor: '#8b5cf6' }] }, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y' } });
            }
        };

        window.addEventListener('DOMContentLoaded', app.init);
    </script>
</body>
</html>